name: Maven Deploy to GitHub Releases

on:
  workflow_call:
    inputs:
      branch:
        required: true
        type: string
      repo_name:
        required: true
        type: string
      token:
        required: true
        type: string


jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

      # Check if the repo_name is provided
      - name: Check repo_name
        run: |
          if [ -z "${{ inputs.repo_name }}" ]; then
            echo "Error: repo_name is required."
            exit 1
          fi

      # Check if the branch is 'main'
      - name: Ensure main branch
        run: |
          if [ "${{ inputs.branch }}" != "main" ]; then
            echo "Error: This workflow can only be triggered for the 'main' branch."
            exit 1
          fi

      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ inputs.token }}

      # Set up Java
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      # Configure Maven settings
      - name: Set up Maven settings
        run: |
          echo "<settings xmlns='http://maven.apache.org/SETTINGS/1.0.0' xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance' xsi:schemaLocation='http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd'>
                  <servers>
                      <server>
                          <id>github</id>
                          <username>${{ secrets.APP_ID }}</username>
                          <password>${{ inputs.token }}</password>
                      </server>
                  </servers>
                  <profiles>
                    <profile>
                      <id>github</id>
                      <repositories>
                        <repository>
                          <snapshots>
                            <enabled>false</enabled>
                          </snapshots>
                          <id>github</id>
                          <url>https://maven.pkg.github.com/evildevsmk/${{ inputs.repo_name }}</url>
                        </repository>
                      </repositories>
                    </profile>
                </profiles>
                <activeProfiles>
                <activeProfile>github</activeProfile>
                </activeProfiles>
              </settings>" > settings-deploy.xml

      - name: Debug token access
        run: |
          curl -H "Authorization: Bearer ${{ steps.generate-token.outputs.token }}" \
               -H "Accept: application/vnd.github+json" \
               https://api.github.com/user/installations
      

      # Run Maven deploy
      - name: Deploy with Maven
        run: mvn deploy -s settings-deploy.xml -X -f pom.xml